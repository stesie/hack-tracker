#! /bin/bash
hacker_name=$1; shift;
hacker_level=$1; shift;
reso_state=""
first=1

for filename in $*; do
	scraped=$("${0%/*}/shot-scraper" "$filename") || scraped=""

	if [ "$scraped" = "" ]; then
		# data not understood, reset state
		reso_state=""
	fi

	if echo "$scraped" | grep -qe "object"; then
		if [ "$first" -eq 1 ]; then
			echo -n "["
			first=0
		else
			echo ","
		fi

		datetime="`perl -e '$_ = shift @ARGV; if(m/Screenshot_(201\d-\d\d-\d\d)-(\d\d)-(\d\d)-(\d\d).png/) { print "$1 $2:$3:$4" };' -- \"${filename##*/}\" `"

		if [ "$datetime" != "" ]; then
			stamp=", \"timestamp\": `date +%s -d \"$datetime\"`"
		fi

		echo -n "{ \"resos\": $reso_state, \"hacker\": { \"name\": \"$hacker_name\", \"level\": $hacker_level }, \"hack\": $scraped$stamp, \"source\": \"${filename##*/}\" }"
	else
		reso_state="$scraped"
	fi
done

if [ "$first" -ne 1 ]; then
	echo "]"
fi
